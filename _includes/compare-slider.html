{% assign before = include.before | default: '/assets/img/before.png' %}
{% assign after = include.after | default: '/assets/img/after.png' %}
{% assign alt_before = include.alt_before | default: 'Before' %}
{% assign alt_after = include.alt_after | default: 'After' %}
{% assign start = include.start | default: 50 %}
{% assign caption = include.caption | default: '' %}
{% assign max_w = include.max_width | default: '100%' %}

{% capture _uid %}{% increment ba_uid %}{% endcapture %}
{% assign _id = include.id | default: 'ba-' | append: _uid %}

<style>
  .ba-wrap{position:relative;max-width:{{ max_w }};margin:0.25rem 0;line-height:0;user-select:none;touch-action:none}
  .ba-wrap img{display:block;width:100%;height:auto;user-select:none;pointer-events:none}
  .ba-top{position:absolute;inset:0;overflow:hidden;z-index:1}
  .ba-handle{position:absolute;top:0;bottom:0;width:2px;background:currentColor;opacity:.9;cursor:ew-resize;z-index:3}
  .ba-grip{position:absolute;top:50%;transform:translate(-50%,-50%);width:38px;height:38px;border-radius:999px;border:2px solid currentColor;background:rgba(255,255,255,.85);display:grid;place-items:center;box-shadow:0 2px 8px rgba(0,0,0,.15)}
  .ba-grip::before{content:"â†”";font-size:14px;line-height:1}
  .ba-caption{text-align:center;font-size:.9rem;margin:.25rem 0 1rem;color:var(--text-muted,#666)}
  @media (prefers-color-scheme: dark){.ba-grip{background:rgba(0,0,0,.5)}}
</style>

<div class="ba-wrap" id="{{ _id }}" role="group" aria-label="Before and after image comparison">
  <img src="{{ after }}" alt="{{ alt_after }}">
  <div class="ba-top" style="clip-path: inset(0 {{ 100-start }}% 0 0);">
    <img src="{{ before }}" alt="{{ alt_before }}">
  </div>
  <div class="ba-handle" style="left: {{ start }}%;">
    <div class="ba-grip" style="left: {{ start }}%;"></div>
  </div>
</div>
{% if caption != '' %}
  <div class="ba-caption">{{ caption }}</div>
{% endif %}

<script>
(function(){
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, {once:true});
    console.log("compare-slider: waiting for DOMContentLoaded");
  } else {
    console.log("compare-slider: DOM already loaded");
    init();
  }

  function init(){
    console.log("compare-slider: init running");

    var wrap = document.getElementById('{{ _id }}');
    console.log("compare-slider: wrap =", wrap);

    if(!wrap) {
      console.warn("compare-slider: wrap not found for id {{ _id }}");
      return;
    }

    var top = wrap.querySelector('.ba-top');
    var handle = wrap.querySelector('.ba-handle');
    var grip = wrap.querySelector('.ba-grip');
    console.log("compare-slider: found elements", {top, handle, grip});

    function setSplit(pct){
      pct = Math.max(0, Math.min(100, pct));
      top.style.clipPath = 'inset(0 ' + (100 - pct) + '% 0 0)';
      handle.style.left = pct + '%';
      grip.style.left = pct + '%';
    }
    setSplit({{ start }});
    console.log("compare-slider: initial split set to {{ start }}%");

    function pointerToPct(e){
      var rect = wrap.getBoundingClientRect();
      var cx = (e.clientX !== undefined) ? e.clientX : (e.touches && e.touches[0].clientX);
      return ((cx - rect.left) / rect.width) * 100;
    }

    var dragging = false;
    function startDrag(e){
      console.log("compare-slider: drag start", e.type);
      dragging = true;
      setSplit(pointerToPct(e));
      e.preventDefault();
    }
    function moveDrag(e){
      if (dragging) {
        setSplit(pointerToPct(e));
      }
    }
    function endDrag(){
      if (dragging) console.log("compare-slider: drag end");
      dragging = false;
    }

    wrap.addEventListener('pointerdown', startDrag);
    window.addEventListener('pointermove', moveDrag);
    window.addEventListener('pointerup', endDrag);

    wrap.addEventListener('mousedown', startDrag);
    window.addEventListener('mousemove', moveDrag);
    window.addEventListener('mouseup', endDrag);

    wrap.addEventListener('touchstart', startDrag, {passive:false});
    window.addEventListener('touchmove', moveDrag, {passive:false});
    window.addEventListener('touchend', endDrag);
    window.addEventListener('touchcancel', endDrag);

    console.log("compare-slider: event listeners attached");
  }
})();
</script>
